(function(e){"use strict";e.fn.exists=function(){return this.length!==0};String.prototype.endsWith=function(e){var t=this.length-e.length;return t>=0&&this.lastIndexOf(e)===t};var t={NotEmpty:0,TooManyResults:1,NoMatchesFound:2,NoSearchParams:3},n=function(n,r){this.ownerDiv=e(r);this.settings=n;this.validator=null;this.init=function(t){if(this.settings.StartPoint==="End"&&t)this.revert();else{this.ownerDiv.hide();this.setSelectedGeoCode("");this.showPromptsForCountry(!1);e(".bfpoBox",this.ownerDiv).hide();e("select",this.ownerDiv).val("229")}};this.showPromptsForCountry=function(t){this.showWaiting(e(".selectCountry"));var n=this.getSelectedGeoCode();if(n==="XXX"){this.noSearchForCountry();return}this.showWaiting();e.post("/AddressCapture/PromptsPerGeoCode",{geoCode:n},{},"json").error(a(this)).success(i(this,t))};var i=function(t,r){return function(i){t.settings.Ready(t);t.hideWaiting();var s=e.render.promptTemplate(i.prompts),o=e.render.findAddressButtonTemplate(i),u=t.ensureDiv(),a=!1;e(":focus",u).trigger("blur");u.empty();n.LineWrapper.length>0?u.append(e(s).wrapAll(n.LineWrapper).parent()):u.append(e(s));u.append(o);var f={ignore:":not(#"+u[0].id+">input)",messages:{}};e("form>#"+u[0].id+" input.required").each(function(){var t=e(this);f.messages[t[0].id]={required:t.data("required-message")};var n=t.data("required-message");e(this).rules("add",{messages:{required:n}});a=!0});e(u.parents("form")).bind("invalid-form.validate",function(r,i){var s=i.numberOfInvalids();if(s){u=t.ensureDiv();var o,a;for(o=0;i.errorList[o];o++){var f=i.errorList[o];u.has(e(f.element)).length>0&&(a=f)}if(a){if(!a.message.endsWith(n.CantSearch)){var l=a.message.slice(0,-1);a.message=l+" "+n.CantSearch}setTimeout(function(){e(".CantSearch",u).click(function(e){e.preventDefault();t.revert()})},750)}}});a&&(t.validator=e("form>#"+u[0].id).validate(f));e(".findButton",u).click(function(e){e.preventDefault();t.searchForAddress()});e(":input",u).keypress(function(e){if(e.which===13){t.searchForAddress();e.preventDefault()}});e(".nonUKCountryButton",u).click(function(e){e.preventDefault();t.pickNewCountry()});r&&e(":text:first",u).focus();n.AfterPromptsShown()}};this.searchForAddress=function(){var t=this.ensureDiv();if(this.validator==null||this.validator.form()){e(".noResults",t).remove();e(".noSearchOptions",t).remove();this.showWaiting(e(".findButton"));var r=e("#"+n.TemplateId+" :input").serialize()+"&geoCode="+this.getSelectedGeoCode();e.post("/AddressCapture/AddressSearch",r,{},"json").error(a(this)).success(s(this))}else{var i=t.find("label.error").last().text().slice(0,-1);t.find("label.error").last().text(i+" ");t.find("label.error").last().append(n.CantSearch);var o=this;e(".CantSearch",t).click(function(e){e.preventDefault();o.revert()})}};var s=function(r){return function(i){r.hideWaiting();console.log(i);if(i.hasOwnProperty("addresses")){var s=r.ensureDiv();e(".noResults",s).remove();e(".noSearchOptions",s).remove();if(i.emptyDataReason===t.TooManyResults){s.prepend(n.TooManyResults);e(".noresult-manual").click(function(t){t.preventDefault();r.revert();e(n.AddresLine1).removeAttr("readonly");e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly");e(n.AddresLine2).focus();e(n.AddresLine1).focus()})}else if(i.emptyDataReason===t.NoSearchParams)s.prepend(n.NoSearchOptions);else if(i.addresses.length>0){e(":focus",s).trigger("blur");s.empty().append(e.render.addressTemplate(i));e("body").data("Address-Search-Data"+n.TemplateId,i);e(" #addressSelector",s).prop("selectedIndex",0);e(".selectAddress",s).click(function(e){e.preventDefault();r.getFullAddress()});e("a.newSearch",s).click(function(t){t.preventDefault();r.showPromptsForCountry("",!0);e(r.ownerDiv).hide();e(":text:first",s).focus()});e("a.manualEntry",s).click(function(t){t.preventDefault();r.revert();e(n.AddresLine1).removeAttr("readonly").focus();e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly")})}else{s.append(n.NoResultsFound);e(".noresult-manual").click(function(t){t.preventDefault();r.revert();e(n.AddresLine1).removeAttr("readonly");e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly");e(n.AddresLine2).focus();e(n.AddresLine1).focus()})}}else{e(r.ownerDiv).show();r.showAddress(i.fullAddress)}}};this.getFullAddress=function(){var t=e("#addressSelector").val();this.showWaiting(e(".selectAddress"));e.post("/AddressCapture/LoadAddress",{addressMoniker:t,geoCode:this.getSelectedGeoCode()},{},"json").error(a(this)).success(o(this))};var o=function(t){return function(r){e("#"+n.TemplateId).remove();t.ownerDiv.show();t.showAddress(r.fullAddress);t.revert()}};this.showAddress=function(t){var r=this.ensureDiv(),i=this;e(":focus",r).trigger("blur");r.empty();e("a",r).click(function(e){i.showPromptsForCountry(i.getSelectedGeoCode(),!0);i.ownerDiv.hide();e.preventDefault()});e(n.AddresLine1).val(t.Address1).trigger("change");e(n.AddresLine2).val(t.Address2).trigger("change");e(n.Town).val(t.Town).trigger("change");e(n.County).val(t.County).trigger("change");e(n.Country).val(t.CountryId).trigger("change");e(n.CountryValue).val(t.CountryId).trigger("change");e(n.CountryValue).selectBox("value",t.CountryId);e(n.CountryText).val(t.Country).trigger("change");e(n.Postcode).val(t.Postcode).trigger("change");n.SearchComplete();e(".postSearchLinks",this.ownerDiv).remove();var s=e("select",this.ownerDiv);s.exists()||(s=e("input",this.ownerDiv).last());e("a.searchAgain",this.ownerDiv).click(function(e){e.preventDefault();i.init(!1)});e("a.editAddress",this.ownerDiv).click(function(t){t.preventDefault();e(n.AddresLine1).removeAttr("readonly").focus();e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly")});e(".serviceErrorMessage",i.ownerDiv).remove()};this.pickNewCountry=function(){this.showWaiting(e(".anotherCountry"));e.post("/AddressCapture/GetCountries",{},{},"json").error(a(this)).success(u(this))};var u=function(t){return function(n){t.hideWaiting();var r=e.render.countrySelectorTemplate(n),i=t.ensureDiv();e(":focus",i).trigger("blur");i.empty().append(r);e.root.domUpdated();typeof e.fn.selectToAutocomplete=="function"&&e("select",i).selectToAutocomplete({sort:!0});e(":input",i).keypress(function(n){if(n.which===13){t.setSelectedGeoCode(e("#addresspicker-country").val());t.showPromptsForCountry(!0);n.preventDefault()}});e(".selectCountry",i).click(function(n){var r=e("#addresspicker-country").selectBox("value");t.setSelectedGeoCode(r);t.showPromptsForCountry(!0);n.preventDefault()});e(".BFPOPrompt a",i).click(function(n){n.preventDefault();t.revert();e(".bfpoBox",t.ownerDiv).show()});e(":text:first",i).focus()}};this.getSelectedGeoCode=function(){return e("body").data("GeoCode"+n.TemplateId)};this.setSelectedGeoCode=function(t){e("body").data("GeoCode"+n.TemplateId,t)};this.noSearchForCountry=function(){var t=this.ensureDiv(),r;typeof e.fn.selectToAutocomplete=="function"?r=e(":text",t).val():r=e("option:selected",t).text();e(".countryErrorMessage",this.ownerDiv).remove();var i=e(e.render.noCountrySearchTemplate({Country:r})).addClass("countryErrorMessage");this.ownerDiv.prepend(i);var s=this;e("a",this.ownerDiv).click(function(t){t.preventDefault();e(".noCountryMessage",s.ownerDiv).remove();s.ownerDiv.hide();s.pickNewCountry()});this.revert();e(n.AddresLine1).removeAttr("readonly").focus();e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly")};this.revert=function(){e("#"+n.TemplateId+" :focus").trigger("blur");e("#"+n.TemplateId).remove();this.ownerDiv.show();n.SearchComplete();e(".postSearchLinks",this.ownerDiv).remove();var t=e("select",this.ownerDiv);t.exists()||(t=e("input",this.ownerDiv).last());e(n.AddresLine1).focus();e(n.AddresLine2);e(n.Town);e(n.County);e(n.Country);e(n.CountryValue);e(n.CountryValue);e(n.CountryText);e(n.Postcode);var r=this;e("a.searchAgain",this.ownerDiv).click(function(e){e.preventDefault();r.init(!1)});e("a.editAddress",this.ownerDiv).click(function(t){t.preventDefault();e(n.AddresLine1).removeAttr("readonly").focus();e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly")})};var a=function(t){return function(){e(".serviceErrorMessage",t.ownerDiv).remove();var r=e(e.render.serviceErrorTemplate({})).addClass("serviceErrorMessage");t.ownerDiv.prepend(r);t.revert();e(n.AddresLine1).removeAttr("readonly").focus();e(n.AddresLine2).removeAttr("readonly");e(n.Town).removeAttr("readonly");e(n.County).removeAttr("readonly");e(n.Country).removeAttr("readonly");e(n.CountryValue).removeAttr("readonly");e(n.CountryText).removeAttr("readonly");e(n.Postcode).removeAttr("readonly")}};this.showWaiting=function(t){if(t){t.addClass("waiting");t.attr("disabled","disabled")}var n=this.ensureDiv();e(".waiting").is("*")||n.append("<div class='waiting'>Loading...</div>")};this.hideWaiting=function(){if(e(".waiting").get(0).tagName==="DIV")return;e(".waiting").removeAttr("disabled").removeClass("waiting")};this.ensureDiv=function(){var t=e("ol#"+n.TemplateId);t.length===0&&e('<ol id="'+n.TemplateId+'" class="AddressFinder"></ol>').insertBefore(this.ownerDiv);return e("ol#"+n.TemplateId)}};e.fn.addressCapture=function(t){var r='<li><label for="{{>ControlName}}">{{>Prompt}}:</label><input id="{{>ControlName}}" name="{{>ControlName}}" title="{{>Example}}" /></li>',i='<li><label for="addressSelector">Select Adress:</label><select size="6" id="addressSelector">{{for addresses}}<option value="{{>Monkier}}">{{>PartialAddress}}</option>{{/for}}</select><br /><span>Address not listed? <a class="newSearch" href="#">Search again</a> or <a href="#">enter address manually</a></span><br /><input type="submit" class="selectAddress" value="Select Address" /></li>',s='<li class="buttons"><input type="submit" name="postcode-lookup-trigger" class="findButton" value="Look up address"><br /><a class="nonUKCountryButton" href="#">{{>countryPrompt}}</a></li>',o='<li class="buttons"><label for="addresspicker-country">Country</label><select id="addresspicker-country" name="addresspicker-country" class="addresspicker-country"><option value="">Please Select..</option>{{for countries}}<option value="{{>GeoCode}}"{{if AlternativeSpellings}} data-alternative-spellings="{{>AlternativeSpellings}}"{{/if}}{{if Boost}}relevancy-score-booster="{{>Boost}}"{{/if}}>{{>Country}}</option>{{/for}}</select><p class="BFPOPrompt"><a href="#">British Forces Post Office address?</a></p><div class="clearer"></div><input type="submit" class="selectCountry bluebutton" value="Confirm Country"><div class="clearer">&nbsp;</div></li>',u='<li class="error"><div class="noCountryMessage"><em>Sorry, but we are unable to search for addresses in your country at this time, please enter your address manually.</em><p><a class="anotherCountry" href="#">Choose Another Country</a></p></div></li>',a='<li class="error"><div class="serviceErrorMessage"><em>Sorry, but we are unable to search for addresses at this time, please enter your address manually.</em></div></li>',f='<li><div class="notYourAddress"><p>Not your address? <a href="#">Search Again</a>.</p></div></li>',l='<li class="error"><div class="noResults"><em>No addresses found, please provide more information and try again, or <a class="noresult-manual" href="#">enter your address manually</a>.</em></div></li>',c='<li class="error"><div class="noResults"><em>Too many matches were found, please try to give more specific details and try again, or <a class="noresult-manual" href="#">enter your address manually</a>.</em></div></li>',h='<li class="error"><div class="noSearchOptions"><em>Please specify at least one search option and try again.</em></div></li>',p='<li><span class="CantSearch">or <a href="#">enter your address manually</a>.</span></li>',d=e.extend({StartPoint:"",AddresLine1:"",AddresLine2:"",Town:"",County:"",Country:"",Postcode:"",LineWrapper:"",LineTemplate:r,AddressTemplate:i,TemplateId:"AddressLookup",FindButtons:s,CountrySelectorLine:o,NoCountrySearch:u,ServiceError:a,NotYourAddress:f,NoResultsFound:l,TooManyResults:c,NoSearchOptions:h,CantSearch:p,SearchComplete:function(){},AfterPromptsShown:function(){},Ready:function(){}},t);e.templates({promptTemplate:d.LineTemplate,addressTemplate:d.AddressTemplate,countrySelectorTemplate:d.CountrySelectorLine,findAddressButtonTemplate:d.FindButtons,noCountrySearchTemplate:d.NoCountrySearch,serviceErrorTemplate:d.ServiceError});return this.each(function(){var e=new n(d,this);e.init(!0)})}})(jQuery);